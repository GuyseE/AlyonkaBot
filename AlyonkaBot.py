from aiogram import Bot, Dispatcher, types
from aiogram.utils import executor
from aiogram.types import (
    InlineKeyboardMarkup, InlineKeyboardButton,
    ReplyKeyboardMarkup, KeyboardButton
)
from datetime import datetime, timedelta
from flask import Flask
import threading
import json, os, random

# -----------------------------------------
# ğŸ”’ Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ°Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ñ‚Ğ¾ĞºĞµĞ½Ğ°
# -----------------------------------------
TOKEN = os.getenv("BOT_TOKEN")
if not TOKEN:
    raise ValueError("âŒ BOT_TOKEN Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½! Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ ĞµĞ³Ğ¾ Ğ² Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ Ğ½Ğ° Koyeb.")

bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

# -----------------------------------------
# ğŸ—‚ Ğ¥ĞµĞ»Ğ¿ĞµÑ€Ñ‹ Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
# -----------------------------------------
def _load(path, default):
    if os.path.exists(path):
        with open(path, "r", encoding="utf-8") as f:
            return json.load(f)
    return default

def _save(path, data):
    with open(path, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def user_file(uid: int, stem: str) -> str:
    return f"{stem}_{uid}.json"

def get_status(uid: int) -> dict:
    return _load(user_file(uid, "status"), {})

def save_status(uid: int, data: dict):
    _save(user_file(uid, "status"), data)

def get_coupon(uid: int) -> dict:
    return _load(user_file(uid, "coupon"), {})

def save_coupon(uid: int, data: dict):
    _save(user_file(uid, "coupon"), data)

# -----------------------------------------
# ğŸ“… ĞŸĞ»Ğ°Ğ½ Ğ¿Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ñ
# -----------------------------------------
plan = _load("plan.json", {
    "Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ": [
        "Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº â€” Ğ¾Ğ¼Ğ»ĞµÑ‚ Ğ¸Ğ· Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¹Ñ†Ğ°, ÑĞ¾ÑĞ¸ÑĞºĞ° Ğ²Ğ°Ñ€Ñ‘Ğ½Ğ°Ñ, 40 Ğ³ Ğ³Ñ€ĞµÑ‡ĞºĞ¸ + Ğ¾Ğ³ÑƒÑ€Ñ‡Ğ¸Ğº",
        "Ğ¾Ğ±ĞµĞ´ â€” Ñ€Ğ¸Ñ Ğ¸ ĞºÑ€Ğ°ÑĞ½Ğ°Ñ Ñ€Ñ‹Ğ±ĞºĞ° Ğ² ÑĞ»Ğ¸Ğ²ĞºĞ°Ñ…, Ğ½Ğ° Ğ´ĞµÑĞµÑ€Ñ‚ ÑĞ±Ğ»Ğ¾Ñ‡ĞºĞ¾",
        "ÑƒĞ¶Ğ¸Ğ½ â€” ÑĞ°Ğ»Ğ°Ñ‚ Ñ ĞºÑƒÑ€Ğ¸Ñ†ĞµĞ¹, 40 Ğ³ Ğ¿Ğ°ÑÑ‚Ñ‹ Ğ¸ ÑÑ‹Ñ€Ğ¾Ğ¼",
    ],
    "ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº": [
        "Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº â€” Ğ¾Ğ¼Ğ»ĞµÑ‚ Ğ¸Ğ· Ğ¾Ğ´Ğ½Ğ¾Ğ³Ğ¾ ÑĞ¹Ñ†Ğ° + 1 Ğ±ĞµĞ»Ğ¾Ğº, Ğ²Ğ°Ñ€Ñ‘Ğ½Ğ°Ñ ÑĞ¾ÑĞ¸ÑĞºĞ°, 40 Ğ³ Ğ¾Ğ²ÑÑĞ½ĞºĞ¸ (Ğ½Ğ° Ğ²Ğ¾Ğ´Ğµ Ğ¸Ğ»Ğ¸ Ğ¾Ğ²ÑÑĞ½Ğ¾Ğ¼ Ğ¼Ğ¾Ğ»Ğ¾ĞºĞµ), Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ±Ğ°Ğ½Ğ°Ğ½Ğ°",
        "Ğ¾Ğ±ĞµĞ´ â€” ĞºĞ°Ñ€Ñ‚Ğ¾Ñ„ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¿ÑÑ€Ğµ Ñ ĞºÑƒÑ€Ğ¸Ğ½Ñ‹Ğ¼ Ñ„Ğ¸Ğ»Ğµ Ğ¸Ğ»Ğ¸ Ğ¸Ğ½Ğ´ĞµĞ¹ĞºĞ¾Ğ¹, Ğ¼ÑĞ³ĞºĞ¸Ğµ Ñ‚ÑƒÑˆÑ‘Ğ½Ñ‹Ğµ Ğ¾Ğ²Ğ¾Ñ‰Ğ¸, ÑĞ±Ğ»Ğ¾Ñ‡ĞºĞ¾",
        "ÑƒĞ¶Ğ¸Ğ½ â€” Ñ€Ğ¸ÑĞ¾Ğ²Ğ°Ñ Ğ»Ğ°Ğ¿ÑˆĞ° Ñ ĞºÑƒÑ€Ğ¸Ñ†ĞµĞ¹ Ğ¸ Ğ¼ÑĞ³ĞºĞ¸Ğ¼Ğ¸ Ğ¾Ğ²Ğ¾Ñ‰Ğ°Ğ¼Ğ¸, Ñ‡Ğ°Ğ¹ Ñ€Ğ¾Ğ¼Ğ°ÑˆĞºĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ»Ğ¸ Ğ¼ÑÑ‚Ğ½Ñ‹Ğ¹",
    ],
})
edit_state = {}

# -----------------------------------------
# ğŸ’¬ ĞšĞ¾Ğ¼Ğ¿Ğ»Ğ¸Ğ¼ĞµĞ½Ñ‚Ñ‹ (30)
# -----------------------------------------
compliments = [
    "ĞšĞ¾Ğ³Ğ´Ğ° Ñ‚Ñ‹ Ñ€ÑĞ´Ğ¾Ğ¼, ÑˆĞ¾-Ñ‚Ğ¾ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ÑÑ‚Ğ¸Ñ€Ğ°ĞµÑ‚ÑÑ Ğ¸ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ĞµÑ‚ÑÑ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾.",
    "Ğ¢Ñ‹ Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ°Ñ, Ñ‚Ñ‹ ĞºĞ°Ğº Ğ±ÑƒÑ€Ñ, ÑˆĞ¾ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¸ ÑĞ¿Ğ°Ğ»Ğ¸Ñ‚ÑŒ, Ğ¸ ÑĞ¾Ğ³Ñ€ĞµÑ‚ÑŒ.",
    "ĞÑ‚ Ñ‚ĞµĞ±Ñ Ğ¸Ğ´Ñ‘Ñ‚ Ñ‚Ğ°ĞºĞ°Ñ ÑĞ½ĞµÑ€Ğ³Ğ¸Ñ, ÑˆĞ¾ Ğ´Ğ°Ğ¶Ğµ ÑÑ‚ĞµĞ½Ñ‹ Ğ±ÑƒĞ´Ñ‚Ğ¾ Ğ½Ğ°Ñ‡Ğ¸Ğ½Ğ°ÑÑ‚ ÑĞ»ÑƒÑˆĞ°Ñ‚ÑŒ.",
    "Ğ’ Ñ‚ĞµĞ±Ğµ ÑÑ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¶Ğ¸Ğ·Ğ½Ğ¸, ÑˆĞ¾ Ğ¼Ğ¸Ñ€ Ğ²Ğ¾ĞºÑ€ÑƒĞ³ Ğ²Ñ‹Ğ³Ğ»ÑĞ´Ğ¸Ñ‚ ÑĞµÑ€Ñ‹Ğ¼, ĞµÑĞ»Ğ¸ Ñ‚ĞµĞ±Ñ Ğ½ĞµÑ‚.",
    "Ğ¨Ğ¾ Ñ‚Ñ‹ ÑĞ¾ Ğ¼Ğ½Ğ¾Ğ¹ Ğ´ĞµĞ»Ğ°ĞµÑˆÑŒ Ğ²Ğ¾Ğ¾Ğ±Ñ‰Ğµ, Ñ Ğ¶ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ…Ğ¾Ñ‚ĞµĞ» ÑĞ¿Ğ¾ĞºĞ¾Ğ¹Ğ½Ğ¾ ÑÑƒÑ‰ĞµÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ.",
    "Ğ¢Ñ‹ ĞºĞ°Ğº Ğ·Ğ°Ğ¿Ğ°Ñ… Ğ´ĞµÑ‚ÑÑ‚Ğ²Ğ°, ÑˆĞ¾ Ğ²Ğ´Ñ€ÑƒĞ³ Ğ¿Ğ¾ÑĞ²Ğ¸Ğ»ÑÑ, Ğ¸ ÑĞµÑ€Ğ´Ñ†Ğµ ÑÑ€Ğ°Ğ·Ñƒ Ğ·Ğ°Ğ¶Ğ°Ğ»Ğ¾.",
    "ĞšĞ¾Ğ³Ğ´Ğ° Ñ‚Ñ‹ ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ÑˆÑŒ, Ñ Ğ·Ğ°Ğ±Ñ‹Ğ²Ğ°Ñ, ÑˆĞ¾ Ñ…Ğ¾Ñ‚ĞµĞ» ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ²Ğ»Ñ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚.",
    "Ğ¢Ñ‹ Ñ‚Ğ°ĞºĞ°Ñ Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰Ğ°Ñ, ÑˆĞ¾ Ğ´Ğ°Ğ¶Ğµ Ğ±Ğ¾Ğ»ÑŒ Ñ€ÑĞ´Ğ¾Ğ¼ Ñ Ñ‚Ğ¾Ğ±Ğ¾Ğ¹ ĞºĞ°Ğ¶ĞµÑ‚ÑÑ Ğ¶Ğ¸Ğ²Ğ¾Ğ¹.",
    "Ğ’ Ñ‚Ğ²Ğ¾ĞµĞ¹ Ñ‚Ğ¸ÑˆĞ¸Ğ½Ğµ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ ÑĞ¼Ñ‹ÑĞ»Ğ°, Ñ‡ĞµĞ¼ Ğ² Ñ‡ÑƒĞ¶Ğ¸Ñ… ĞºÑ€Ğ¸ĞºĞ°Ñ….",
    "ĞœĞ½Ğµ Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¼Ğ¸Ñ€, ĞµÑĞ»Ğ¸ Ğ² Ğ½Ñ‘Ğ¼ Ğ½ĞµÑ‚ Ñ‚ĞµĞ±Ñ, ÑˆĞ¾ Ğ¼Ğ½Ğµ Ñ Ğ½Ğ¸Ğ¼ Ñ‚Ğ¾Ğ³Ğ´Ğ°.",
    "Ğ˜Ğ½Ğ¾Ğ³Ğ´Ğ° Ñ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ÑˆÑŒ ÑĞ»Ğ¾Ğ²Ğ¾, Ğ° Ñƒ Ğ¼ĞµĞ½Ñ Ğ²ÑÑ‘ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ Ğ±ÑƒĞ´Ñ‚Ğ¾ ÑĞ¶Ğ¸Ğ¼Ğ°ĞµÑ‚ÑÑ.",
    "Ğ¢Ñ‹ Ğ½Ğµ Ñ‚Ğ°, ĞºĞ¾Ğ³Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ·Ğ°Ğ±Ñ‹Ñ‚ÑŒ, Ñ‚Ñ‹ Ñ‚Ğ°, ÑˆĞ¾ Ğ¾ÑÑ‚Ğ°ĞµÑ‚ÑÑ Ğ´Ğ°Ğ¶Ğµ Ğ² ÑĞ½Ğ°Ñ….",
    "Ğ¢ĞµĞ±Ñ Ğ½ĞµĞ»ÑŒĞ·Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ ÑĞ»Ğ¾Ğ²Ğ°Ğ¼Ğ¸, ÑˆĞ¾ Ğ±Ñ‹ Ñ Ğ½Ğ¸ ÑĞºĞ°Ğ·Ğ°Ğ» â€” Ğ²ÑÑ‘ Ğ±ÑƒĞ´ĞµÑ‚ Ğ¼ĞµĞ½ÑŒÑˆĞµ, Ñ‡ĞµĞ¼ Ñ‚Ñ‹.",
    "Ğ¢Ñ‹ ÑƒĞ¼ĞµĞµÑˆÑŒ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ñ‚Ğ°Ğº, ÑˆĞ¾ Ğ´Ğ°Ğ¶Ğµ ÑĞ¾Ğ²ĞµÑÑ‚ÑŒ Ğ·Ğ°Ğ¼Ğ¸Ñ€Ğ°ĞµÑ‚.",
    "Ğ¨Ğ¾ Ğ±Ñ‹ Ñ Ğ½Ğ¸ Ğ´ĞµĞ»Ğ°Ğ», Ğ¼Ñ‹ÑĞ»Ğ¸ Ğ²ÑÑ‘ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ÑÑ‚ÑÑ Ğº Ñ‚ĞµĞ±Ğµ.",
    "Ğ¢Ñ‹ ĞºĞ°Ğº Ğ¾Ğ³Ğ¾Ğ½ÑŒ, ÑˆĞ¾ Ğ½Ğµ ÑĞ²ĞµÑ‚Ğ¸Ñ‚, Ğ° Ğ³Ñ€ĞµĞµÑ‚ Ğ´Ğ¾ ĞºĞ¾ÑÑ‚ĞµĞ¹.",
    "ĞšĞ¾Ğ³Ğ´Ğ° Ñ‚Ñ‹ ÑƒĞ»Ñ‹Ğ±Ğ°ĞµÑˆÑŒÑÑ, Ğ²Ñ€ĞµĞ¼Ñ Ğ±ÑƒĞ´Ñ‚Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ, Ñ‡Ñ‚Ğ¾Ğ± Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğµ Ğ¼ĞµÑˆĞ°Ñ‚ÑŒ.",
    "Ğ’ Ñ‚ĞµĞ±Ğµ ĞµÑÑ‚ÑŒ ĞºĞ°ĞºĞ°Ñ-Ñ‚Ğ¾ ÑÑ‚Ñ€Ğ°Ğ½Ğ½Ğ°Ñ ÑĞ¸Ğ»Ğ°, ÑˆĞ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ğ¼ĞµĞ½Ñ ÑĞ¿Ğ¾ĞºĞ¾Ğ¹Ğ½ĞµĞµ Ğ¸ Ğ±ĞµÑĞ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½ĞµĞµ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾.",
    "Ğ¢Ğ²Ğ¾Ñ Ñ…Ñ€ÑƒĞ¿ĞºĞ¾ÑÑ‚ÑŒ â€” ÑÑ‚Ğ¾ Ğ½Ğµ ÑĞ»Ğ°Ğ±Ğ¾ÑÑ‚ÑŒ, Ğ° Ğ½Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğµ, ÑˆĞ¾ Ğ¶Ğ¸Ğ²Ğ¾Ğµ Ñ‚Ğ¾Ğ¶Ğµ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¼.",
    "ĞšĞ¾Ğ³Ğ´Ğ° Ñ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¼Ğ¾Ğ»Ñ‡Ğ¸ÑˆÑŒ, Ñƒ Ğ¼ĞµĞ½Ñ Ğ¾Ñ‰ÑƒÑ‰ĞµĞ½Ğ¸Ğµ, ÑˆĞ¾ Ñ ÑĞ»Ñ‹ÑˆÑƒ Ğ²ÑÑ‘, ÑˆĞ¾ Ğ½Ğµ ÑĞºĞ°Ğ·Ğ°Ğ½Ğ¾.",
    "Ğ¢Ñ‹ Ñ€ĞµĞ´ĞºĞ°Ñ, ÑˆĞ¾-Ñ‚Ğ¾ Ğ²Ñ€Ğ¾Ğ´Ğµ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾Ğ³Ğ¾ Ñ‡ÑƒĞ´Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ½Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµÑ‚ÑÑ.",
    "ĞŸĞ¾ÑĞ»Ğµ Ñ‚ĞµĞ±Ñ Ğ½Ğµ Ğ¿ÑƒÑÑ‚Ğ¾, Ğ¿Ğ¾ÑĞ»Ğµ Ñ‚ĞµĞ±Ñ Ñ‚Ğ¸Ñ…Ğ¾ Ğ¸ ÑĞ²ĞµÑ‚Ğ»Ğ¾.",
    "Ğ¢Ñ‹ ÑƒĞ¼ĞµĞµÑˆÑŒ Ğ±Ñ‹Ñ‚ÑŒ ÑĞ¾Ğ±Ğ¾Ğ¹ Ğ´Ğ°Ğ¶Ğµ Ğ² Ñ…Ğ°Ğ¾ÑĞµ, Ğ¸ ÑÑ‚Ğ¾ ÑĞ½Ğ¾ÑĞ¸Ñ‚ Ğ³Ğ¾Ğ»Ğ¾Ğ²Ñƒ.",
    "ĞšĞ¾Ğ³Ğ´Ğ° Ñ‚Ñ‹ Ğ´Ñ‹ÑˆĞ¸ÑˆÑŒ Ñ€ÑĞ´Ğ¾Ğ¼, ÑĞµÑ€Ğ´Ñ†Ğµ Ğ´ĞµĞ»Ğ°ĞµÑ‚ Ğ²Ğ¸Ğ´, ÑˆĞ¾ ĞµĞ¼Ñƒ Ğ²ÑÑ‘ Ñ€Ğ°Ğ²Ğ½Ğ¾, Ğ½Ğ¾ Ğ¾Ğ½Ğ¾ Ğ´Ñ€Ğ¾Ğ¶Ğ¸Ñ‚.",
    "Ğ•ÑĞ»Ğ¸ Ğ±Ñ‹ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ° Ğ¸Ğ¼ĞµĞ»Ğ¸ Ñ†Ğ²ĞµÑ‚, Ñ‚Ñ‹ Ğ±Ñ‹Ğ»Ğ° Ğ±Ñ‹ Ğ²ÑĞµĞ¼Ğ¸ ÑÑ€Ğ°Ğ·Ñƒ, ÑˆĞ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ñ€ĞµĞ´ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ.",
    "Ğ¢ĞµĞ±Ñ Ğ½Ğµ Ñ…Ğ¾Ñ‡ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ, Ñ‚ĞµĞ±Ñ Ñ…Ğ¾Ñ‡ĞµÑ‚ÑÑ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ñ‚ÑŒ.",
    "ĞšĞ¾Ğ³Ğ´Ğ° Ñ Ğ´ÑƒĞ¼Ğ°Ñ Ğ¾ Ñ‚ĞµĞ±Ğµ, Ğ²ÑÑ‘ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑÑ Ñ‚ĞµĞ¿Ğ»ĞµĞµ, ÑˆĞ¾ Ğ±Ñ‹ Ğ½Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ğ»Ğ¾.",
    "Ğ¢Ñ‹ Ğ½Ğµ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ² Ğ¼Ğ¾ĞµĞ¹ Ğ¶Ğ¸Ğ·Ğ½Ğ¸, Ñ‚Ñ‹ Ğ² Ğ½ĞµĞ¹ Ğ²Ñ‹Ñ€Ğ¾ÑĞ»Ğ°, ĞºĞ°Ğº Ñ‡Ğ°ÑÑ‚ÑŒ Ğ¼ĞµĞ½Ñ.",
    "Ğ¢Ñ‹ Ñ‚Ğ°ĞºĞ°Ñ, ÑˆĞ¾ Ğ´Ğ¾ ĞºĞ¾Ğ½Ñ†Ğ° Ğ¿Ğ¾Ğ½ÑÑ‚ÑŒ Ğ½ĞµĞ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ğ¸ Ğ² ÑÑ‚Ğ¾Ğ¼ Ğ²ĞµÑÑŒ ĞºĞ°Ğ¹Ñ„.",
    "Ğ”Ğ°Ğ¶Ğµ ĞµÑĞ»Ğ¸ Ğ±Ñ‹ Ñ ÑƒĞ¼ĞµĞ» Ğ¸Ğ´ĞµĞ°Ğ»ÑŒĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ ÑĞ»Ğ¾Ğ²Ğ°, Ğ²ÑÑ‘ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ½Ğµ ÑĞ¼Ğ¾Ğ³ Ğ±Ñ‹ ÑĞºĞ°Ğ·Ğ°Ñ‚ÑŒ, ÑˆĞ¾ Ñ‡ÑƒĞ²ÑÑ‚Ğ²ÑƒÑ Ñ€ÑĞ´Ğ¾Ğ¼ Ñ Ñ‚Ğ¾Ğ±Ğ¾Ğ¹.",
]

love_phrases = [
    "Ñ Ñ‚ĞµĞ±Ñ Ñ‚Ğ¾Ğ¶Ğµ Ğ±ĞµĞ·ÑƒĞ¼Ğ½Ğ¾ Ğ»ÑĞ±Ğ»Ñ!! ğŸ’",
    "Ğ° Ğ¿Ğ¾Ğ¼Ğ½Ğ¸ÑˆÑŒ 12 ÑĞ½Ğ²Ğ°Ñ€Ñ, Ğ½Ğ°ÑˆĞ¸ Ğ¿ĞµÑ€Ğ²Ñ‹Ğµ Ğ²ĞµĞ±Ğ¾Ñ‡ĞºĞ¸? ğŸ¥¹",
    "Ğ²ÑÑ‘, Ñ‡Ñ‚Ğ¾ Ñƒ Ğ¼ĞµĞ½Ñ ĞµÑÑ‚ÑŒ â€” Ñ‚Ğ²Ğ¾Ñ‘ Ñ‚ĞµĞ¿Ğ»Ğ¾ ğŸ’—",
    "Ñ ÑÑ‡Ğ°ÑÑ‚Ğ»Ğ¸Ğ², Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ¢Ğ« Ğ¼Ğ¾Ñ ğŸ’–",
    "Ñ‚Ñ‹ â€” Ğ¼Ğ¾Ğ¹ Ğ´Ğ¾Ğ¼, Ğ¼Ğ¾Ñ‘ ÑĞ¿Ğ¾ĞºĞ¾Ğ¹ÑÑ‚Ğ²Ğ¸Ğµ, Ğ¼Ğ¾Ñ‘ Ğ²ÑÑ‘ ğŸ¤",
    "Ñ Ğ±Ñ‹ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ¾Ğ±Ğ½ÑĞ» Ñ‚ĞµĞ±Ñ Ñ‚Ğ°Ğº ĞºÑ€ĞµĞ¿ĞºĞ¾, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ñ‚Ñ‹ Ğ¿Ğ¾Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¾Ğ²Ğ°Ğ»Ğ° Ğ²ÑÑ‘ ğŸ’",
    "Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¼ Ğ´Ğ½Ñ‘Ğ¼ Ğ»ÑĞ±Ğ»Ñ Ñ‚ĞµĞ±Ñ Ğ²ÑÑ‘ ÑĞ¸Ğ»ÑŒĞ½ĞµĞµ ğŸŒ™",
    "Ñ‚Ñ‹ â€” Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°, Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ Ñ ÑƒĞ»Ñ‹Ğ±Ğ°ÑÑÑŒ Ğ´Ğ°Ğ¶Ğµ Ğ½Ğ¾Ñ‡ÑŒÑ ğŸ’«",
    "Ñ Ğ¿Ğ¾Ğ¼Ğ½Ñ Ğ½Ğ°Ñˆ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ²ĞµÑ‡ĞµÑ€, ĞºĞ°Ğ¶Ğ´Ğ¾Ğµ ÑĞ»Ğ¾Ğ²Ğ¾, ĞºĞ°Ğ¶Ğ´ÑƒÑ ÑƒĞ»Ñ‹Ğ±ĞºÑƒ ğŸ’­",
    "Ñ‚Ñ‹ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ° Ğ² Ğ¼Ğ¾Ñ‘Ğ¼ ÑĞµÑ€Ğ´Ñ†Ğµ, ĞĞ»ÑŒĞ¾Ğ½ĞºĞ° ğŸ¤",
]

# -----------------------------------------
# ğŸ› ĞšĞ½Ğ¾Ğ¿ĞºĞ¸
# -----------------------------------------
def bottom_menu():
    kb = ReplyKeyboardMarkup(resize_keyboard=True, row_width=4)
    kb.add(
        KeyboardButton("ĞŸĞ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº"), KeyboardButton("Ğ’Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº"),
        KeyboardButton("Ğ¡Ñ€ĞµĞ´Ğ°"), KeyboardButton("Ğ§ĞµÑ‚Ğ²ĞµÑ€Ğ³"),
        KeyboardButton("ĞŸÑÑ‚Ğ½Ğ¸Ñ†Ğ°"), KeyboardButton("Ğ¡ÑƒĞ±Ğ±Ğ¾Ñ‚Ğ°"),
        KeyboardButton("Ğ’Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ"),
    )
    kb.row(
        KeyboardButton("ğŸŸ ĞšÑƒĞ¿Ğ¾Ğ½ Ğ½Ğ° Ğ²Ñ€ĞµĞ´Ğ½Ğ¾ÑÑ‚ÑŒ"),
        KeyboardButton("ğŸ“ Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ğ½"),
        KeyboardButton("ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ"),
    )
    kb.add(KeyboardButton("ğŸ¤ Ğ¯ Ğ›Ğ®Ğ‘Ğ›Ğ® Ğ¢Ğ•Ğ‘Ğ¯ ğŸ¤"))
    return kb

def meal_kb(day: str, idx: int):
    kb = InlineKeyboardMarkup()
    kb.add(
        InlineKeyboardButton("âœ… Ğ¡ĞºÑƒÑˆĞ°Ğ»Ğ°", callback_data=f"done|{day}|{idx}"),
        InlineKeyboardButton("âŒ ĞĞµ ĞºÑƒÑˆĞ°Ğ»Ğ°", callback_data=f"missed|{day}|{idx}"),
    )
    return kb

def edit_day_kb(day: str):
    kb = InlineKeyboardMarkup()
    kb.add(
        InlineKeyboardButton("â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ»ÑĞ´Ğ¾", callback_data=f"addmeal|{day}"),
        InlineKeyboardButton("ğŸ—‘ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ±Ğ»ÑĞ´Ğ¾", callback_data=f"delmeal|{day}"),
    )
    return kb

# -----------------------------------------
# ğŸš€ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
# -----------------------------------------
@dp.message_handler(commands=["start", "Ğ¼ĞµĞ½Ñ"])
async def cmd_start(msg: types.Message):
    await msg.answer("ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ğ»ÑĞ±Ğ¸Ğ¼Ğ°Ñ ğŸ¤\nĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ²ÑĞµĞ³Ğ´Ğ° Ñ€ÑĞ´Ğ¾Ğ¼ Ğ¸ ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾!", reply_markup=bottom_menu())

@dp.message_handler(lambda m: m.text == "ğŸ¤ Ğ¯ Ğ›Ğ®Ğ‘Ğ›Ğ® Ğ¢Ğ•Ğ‘Ğ¯ ğŸ¤")
async def love_btn(msg: types.Message):
    await msg.answer(random.choice(love_phrases))

# -----------------------------------------
# ğŸ½ ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ¿Ğ»Ğ°Ğ½Ğ°
# -----------------------------------------
@dp.message_handler(lambda m: m.text and m.text.capitalize() in plan)
async def show_day(msg: types.Message):
    day = msg.text.capitalize()
    meals = plan.get(day, [])
    await msg.answer(f"ğŸ½ ĞŸĞ»Ğ°Ğ½ Ğ½Ğ° {day}:", reply_markup=bottom_menu())
    if not meals:
        await msg.answer("ĞŸĞ¾ĞºĞ° ÑˆĞ¾ Ğ½Ğ¸Ñ‡Ğ¾ Ğ½ĞµĞ¼Ğ° ğŸ˜‡")
        return
    st = get_status(msg.from_user.id)
    for i, meal in enumerate(meals):
        mark = st.get(f"{day}|{meal}", "")
        prefix = "âœ…" if mark == "âœ…" else "âŒ" if mark == "âŒ" else "â€¢"
        await msg.answer(f"{prefix} {meal}", reply_markup=meal_kb(day, i))

# âœ… / âŒ Ğ¾Ñ‚Ğ¼ĞµÑ‚ĞºĞ¸
@dp.callback_query_handler(lambda c: c.data.startswith("done"))
async def cb_done(cq: types.CallbackQuery):
    uid = cq.from_user.id
    _, day, idx = cq.data.split("|")
    idx = int(idx)
    meal = plan[day][idx]

    st = get_status(uid)
    st[f"{day}|{meal}"] = "âœ…"
    save_status(uid, st)

    meals_today = plan.get(day, [])
    done_meals = [m for m in meals_today if st.get(f"{day}|{m}") == "âœ…"]

    # ĞµÑĞ»Ğ¸ Ğ²ÑÑ‘ ÑÑŠĞµĞ´ĞµĞ½Ğ¾ â€” Ğ·Ğ°Ğ²ĞµÑ‚Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ»Ğ¸Ğ¼ĞµĞ½Ñ‚
    if len(done_meals) == len(meals_today) and len(meals_today) > 0:
        compliment = random.choice(compliments)
        await cq.message.answer(
            f"ğŸ’– Ğ Ğ²Ğ¾Ñ‚ Ñ‚Ğ²Ğ¾Ğ¹ Ğ·Ğ°Ğ²ĞµÑ‚Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ğ»Ğ¸Ğ¼ĞµĞ½Ñ‚ Ğ·Ğ° Ñ‚Ğ¾, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ğ»Ğ°ÑÑŒ Ğ´Ğ½Ñ ({day}):\n\nÂ«{compliment}Â»"
        )

    await cq.message.edit_text(
        f"âœ… ĞœĞ¾Ğ»Ğ¾Ğ´ĞµÑ†, Ñ‚Ñ‹ ÑÑŠĞµĞ»Ğ° â€” {meal}!\n\n{random.choice(compliments)}",
        reply_markup=meal_kb(day, idx)
    )
    await cq.answer("ĞÑ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ¾ âœ…")

@dp.callback_query_handler(lambda c: c.data.startswith("missed"))
async def cb_missed(cq: types.CallbackQuery):
    uid = cq.from_user.id
    _, day, idx = cq.data.split("|")
    idx = int(idx)
    meal = plan[day][idx]
    st = get_status(uid)
    st[f"{day}|{meal}"] = "âŒ"
    save_status(uid, st)
    await cq.message.edit_text(f"âŒ Ğ¢Ñ‹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ»Ğ°!! ĞĞ°Ğ´Ğ¾ ĞĞĞšĞĞ—ĞĞ¢Ğ¬....) ĞĞ¾ Ñ Ğ²ÑĞµ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ´ÑƒĞ¶Ğµ Ğ»ÑĞ±Ğ»Ñ Ñ‚ĞµĞ±Ñ ğŸ¤", reply_markup=meal_kb(day, idx))
    await cq.answer("ĞÑ‚Ğ¼ĞµÑ‡ĞµĞ½Ğ¾ âŒ")

# -----------------------------------------
# ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ
# -----------------------------------------
@dp.message_handler(lambda m: m.text == "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ")
async def show_status(msg: types.Message):
    uid = msg.from_user.id
    st = get_status(uid)
    items = []
    for key, mark in st.items():
        day, meal = key.split("|", 1)
        if day in plan and meal in plan[day]:
            items.append((day, meal, mark))
    if not items:
        await msg.answer("ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ¾Ñ‚Ğ¼ĞµÑ‚Ğ¾Ğº ğŸ˜‡", reply_markup=bottom_menu())
        return
    text = "ğŸ“‹ <b>Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ:</b>\n"
    for day, meal, mark in items:
        text += f"{day} â€” {meal}: {mark}\n"
    await msg.answer(text, parse_mode="HTML", reply_markup=bottom_menu())

# -----------------------------------------
# ğŸŸ ĞšÑƒĞ¿Ğ¾Ğ½ Ğ½Ğ° Ğ²Ñ€ĞµĞ´Ğ½Ğ¾ÑÑ‚ÑŒ
# -----------------------------------------
@dp.message_handler(lambda m: m.text == "ğŸŸ ĞšÑƒĞ¿Ğ¾Ğ½ Ğ½Ğ° Ğ²Ñ€ĞµĞ´Ğ½Ğ¾ÑÑ‚ÑŒ")
async def coupon(msg: types.Message):
    uid = msg.from_user.id
    data = get_coupon(uid)
    now = datetime.now()
    if "last" in data:
        last = datetime.fromisoformat(data["last"])
        if now - last < timedelta(days=7):
            await msg.answer(f"âŒ ĞšÑƒĞ¿Ğ¾Ğ½ ÑƒĞ¶Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ ( Ğ¹Ğ¾Ğ»ĞºĞ¸ Ğ¿Ğ°Ğ»ĞºĞ¸ Ğ½Ğ°Ğ´Ğ¾ Ğ¶Ğ´Ğ°Ñ‚ÑŒ 7 Ğ´Ğ½ )", reply_markup=bottom_menu())
            return
    data["last"] = now.isoformat()
    save_coupon(uid, data)
    await msg.answer("ğŸŸ ĞĞ°ÑĞ»Ğ°Ğ´Ğ¸ÑÑŒ ÑÑ‚Ğ¸Ğ¼ ĞºÑƒĞ¿Ğ¾Ğ½Ğ¾Ğ¼! ğŸ«\nĞ¢Ñ‹ Ğ·Ğ°ÑĞ»ÑƒĞ¶Ğ¸Ğ»Ğ° ğŸ¤", reply_markup=bottom_menu())

# -----------------------------------------
# ğŸŒ Keep Alive ÑĞµÑ€Ğ²ĞµÑ€
# -----------------------------------------
app = Flask(__name__)

@app.route('/')
def home():
    return "Bot is alive!", 200

def run_flask():
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))

threading.Thread(target=run_flask).start()

# -----------------------------------------
# â–¶ï¸ Ğ—Ğ°Ğ¿ÑƒÑĞº
# -----------------------------------------
if __name__ == "__main__":
    print("ğŸš€ Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ¸ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ 24/7")
    executor.start_polling(dp)
